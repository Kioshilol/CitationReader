@page "/external-vehicles"
@using CitationReader.Services.Huur.Vehicle
@using CitationReader.Models.Huur
@using CitationReader.Services.Huur.Auth
@inject IVehicleService VehicleService
@inject IAuthService AuthService

<PageTitle>External Vehicles</PageTitle>

<h1>External Vehicles</h1>

@if (isLoading)
{
    <div class="loading">
        <p>Loading vehicles...</p>
    </div>
}
else if (errorMessage != null)
{
    <div class="alert alert-danger">
        <strong>Error:</strong> @errorMessage
    </div>
}
else if (vehicles != null && vehicles.Any())
{
    <div class="vehicles-container">
        <p class="vehicle-count">Total vehicles: @vehicles.Count()</p>
        
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Label</th>
                        <th>License Plate</th>
                        <th>VIN</th>
                        <th>Make</th>
                        <th>Model</th>
                        <th>Year</th>
                        <th>Color</th>
                        <th>State</th>
                        <th>Country</th>
                        <th>Active</th>
                        <th>Created</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var vehicle in vehicles)
                    {
                        <tr class="@(vehicle.IsActive ? "" : "table-secondary")">
                            <td>@vehicle.Id</td>
                            <td>@vehicle.Label</td>
                            <td>
                                <span class="license-plate">@vehicle.LicensePlate</span>
                            </td>
                            <td>
                                <small class="text-muted">@vehicle.Vin</small>
                            </td>
                            <td>@vehicle.Make</td>
                            <td>@vehicle.Model</td>
                            <td>@vehicle.Year</td>
                            <td>@vehicle.Color</td>
                            <td>
                                <span class="badge @GetStateBadgeClass(vehicle.State)">
                                    @vehicle.State
                                </span>
                            </td>
                            <td>@vehicle.Country</td>
                            <td>
                                @if (vehicle.IsActive)
                                {
                                    <span class="badge bg-success">Active</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">Inactive</span>
                                }
                            </td>
                            <td>
                                @if (vehicle.CreatedAt.HasValue)
                                {
                                    <small>@vehicle.CreatedAt.Value.ToString("MM/dd/yyyy")</small>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}
else
{
    <div class="no-vehicles">
        <p>No external vehicles found.</p>
    </div>
}

<style>
    .vehicles-container {
        margin-top: 20px;
    }

    .vehicle-count {
        font-weight: bold;
        margin-bottom: 15px;
        color: #6c757d;
    }

    .license-plate {
        font-family: monospace;
        font-weight: bold;
        background-color: #f8f9fa;
        padding: 2px 6px;
        border-radius: 3px;
        border: 1px solid #dee2e6;
    }

    .loading {
        text-align: center;
        padding: 40px;
    }

    .no-vehicles {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }

    .table th {
        font-size: 0.9rem;
        font-weight: 600;
    }

    .table td {
        vertical-align: middle;
    }

    .alert {
        margin-top: 20px;
    }
</style>

@code {
    private IEnumerable<ExternalVehicleDto>? vehicles;
    private bool isLoading = true;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var isSuccess = await AuthService.TrySignInAsync();
            if (!isSuccess)
            {
                return;
            }
            
            var response = await VehicleService.GetExternalVehiclesAsync();
            if (response is { IsSuccess: true, Result: not null })
            {
                vehicles = response.Result;
            }
            else
            {
                errorMessage = response.Message ?? "Failed to load vehicles";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetStateBadgeClass(string? state)
    {
        return state?.ToLower() switch
        {
            "active" => "bg-success",
            "inactive" => "bg-secondary",
            "maintenance" => "bg-warning",
            "out_of_service" => "bg-danger",
            _ => "bg-info"
        };
    }
}
